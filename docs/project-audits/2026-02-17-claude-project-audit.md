<!-- AGENT NOTE: This is a point-in-time snapshot from 2026-02-17. It may be
     useful for quick orientation, but DO NOT rely on it as the source of truth.
     Cross-check against the canonical progress files (phase-N-progress.md),
     canopy-spec.md, and actual source code — especially for implementation
     status, known bugs, and phase completion. -->

# Canopy Reader — Project Audit — 2026-02-17 (Claude)
Generated by Claude Code coding agent on Tuesday, February 17, 2026.

**Date**: 2026-02-17
**Scope**: Full project audit — purpose, architecture, progress, risks, and source inventory.

---

## 1. Project Understanding

### 1.1 Purpose, Architecture, Major Features

**Purpose**: Canopy is a **self-hosted read-it-later and knowledge management app** (a personal Readwise Reader clone). It's a single-user app  deployed entirely on Cloudflare infrastructure at `canopy.annjose.com`.

**Architecture**:
- **Monorepo** — pnpm workspaces + Turborepo with two active packages:
  - `@canopy/web` (`apps/web`) — Next.js 15 App Router, the entire app
  - `@canopy/shared` (`packages/shared`) — shared types & constants
- **Runtime** — Cloudflare Workers via `opennextjs-cloudflare` adapter
- **Database** — Cloudflare D1 (SQLite), 3 migrations applied (documents, tags/notes/highlights, feeds)
- **Storage** — Cloudflare R2 for article HTML, thumbnails, future EPUB/PDF originals
- **Auth** — Cloudflare Access (Zero Trust JWT verification, bypassed on localhost)
- **State management** — SWR for server data, React Context (`AppShellContext`) for UI state (theme, panel visibility, dialogs, selected document)
- **UI** — Three-panel layout (sidebar 240px | main flex | right panel 320px), responsive down to mobile with Sheet overlays. shadcn/ui primitives (Dialog, Command, Toast), Lucide icons, Tailwind CSS v4.

**Major implemented features**:
- Save articles by URL with content extraction (Mozilla Readability + linkedom)
- Three-panel layout: sidebar navigation, document list with status tabs (inbox/reading/later/archive), right panel (Info + Notebook tabs)
- Clean reader view with font size controls, ToC, reading progress persistence, prev/next navigation
- Vim-style keyboard shortcuts (single-key + chord bindings like `g h`) with help modal
- Command palette search (full-text across title/author/description/domain)
- Tags: create, rename, merge, delete; tag picker dialog on documents; filter by tag in sidebar
- Highlights: text selection → color-coded highlights with notes, rendered in reader, manageable in Notebook panel
- Document-level notes with markdown
- Markdown export of notes + highlights
- RSS feeds: subscribe by URL (with auto-discovery), feed polling, OPML import, folder grouping, edit/delete feeds, mark-all-read, feed titles on document rows
- Dark mode / light mode toggle
- Mobile responsive layout with drawer panels

---

### 1.2 Current Implementation Progress

| Phase | Description                     | Status          |
|-------|---------------------------------|-----------------|
| 1     | Foundation & Core Reading (MVP) | **Complete**    |
| 2     | Tags, Notes & Highlights        | **Complete**    |
| 3     | RSS Feeds                       | **Complete**    |
| 4     | File Uploads (PDF)              | **Not started** |
| 5     | Newsletter / Email Integration  | **Not started** |
| 6     | Browser Extension               | **Not started** |
| 7     | Obsidian Integration            | **Not started** |
| 8     | Polish & Advanced Features      | **Not started** |

**Phase 1** (6 feature steps + 5 setup steps): All done. Project setup, document CRUD, reader view, three-panel layout, keyboard shortcuts, search, mobile responsive.

**Phase 2** (11 milestones): All done. Tags CRUD + tag picker, highlights with color coding + notes, document notes, Notebook panel, markdown export, reading progress persistence, panel toggle shortcuts, font size controls, dark mode.

**Phase 3** (9 milestones): All done. Feeds table migration, RSS/Atom parser (`fast-xml-parser`), feed auto-discovery, feed DB helpers, feed CRUD API, feed polling logic, SWR hooks + client API, feeds UI (sidebar entry + `/feeds` page), feed editing/folders/error states, OPML import.

---

### 1.3 Interesting Findings, Risks, Inconsistencies & Notes

#### Inconsistencies / spec drift

1. **Adapter name mismatch in spec** — `docs/canopy-spec.md:57` says `@cloudflare/next-on-pages` or `opennextjs-cloudflare`. The `AGENTS.md` rule explicitly says use `opennextjs-cloudflare` (which is what the code uses). The spec should be updated.

2. **Tag `name` vs `slug` divergence** — The spec (`canopy-spec.md:106`) defines tags with a `name` field in kebab-case. The actual implementation uses *both* `name` (display, user-entered, can have spaces/case) and `slug` (kebab-case, unique). This is a better design but differs from the spec's data model.

3. **Phase 3 progress file naming** — Phases 1 and 2 follow the convention `phase-N-progress.md` as a separate file. Phase 3 combines plan + progress into a single file `phase-3-rss-feeds.md`. No separate `phase-3-progress.md` exists (despite the `AGENTS.md` convention requiring one).

4. **Cron trigger not yet active** — The spec says Phase 3 includes "Cloudflare Workers Cron Trigger (every 30 minutes)" for automatic feed polling. The `wrangler.toml` has this commented out with a note saying "Phase 8". Feed polling currently works only via manual `POST /api/feeds/poll` API calls. The spec's Phase 8 also lists "Automatic feed polling" as a task — so it was deliberately deferred, but the Phase 3 plan marks itself as "Complete" despite this.

5. **`docs/canopy-spec.md` has a trailing empty section** — The file ends with `## Current Status` (line 537) followed by nothing. This looks like an incomplete edit.

#### Risks

6. **No tests** — The `docs/repo-structure.md` mentions "Testing will be added in a dedicated pass after the core Phase 1 implementation" (Vitest, API integration tests, component tests). Three phases later, there are still zero tests. As features compound, the risk of regressions grows.

7. **No rate limiting or input validation on API routes** — While it's a single-user app behind Cloudflare Access, the API routes construct SQL with dynamic `WHERE` clauses using string interpolation for column names (e.g., `sort` field in `db.ts:112`). The `sort` parameter is constrained to a TypeScript type but isn't validated at runtime in the API route — a malicious or malformed request could potentially inject SQL via the sort field.

8. **Search is LIKE-based** — Search uses `LIKE %query%` which doesn't use indexes and will degrade with scale. D1 supports FTS5 which would be more appropriate, but may be fine for a single-user app.

9. **No 30-day trash auto-purge** — The spec mentions "Trash — soft delete, recoverable for 30 days" but there's no scheduled job to permanently delete old trashed documents.

10. **Reading progress race condition** — Progress is saved with a 1.5s debounce on scroll. If the user navigates away quickly, the last scroll position could be lost (though this is a common trade-off).

#### Notable design choices

11. **Cursor-based pagination** — The document list uses cursor-based pagination (not offset), which is correct for chronologically-sorted data.

12. **Eager tag/feed loading** — `listDocuments` in `db.ts` eager-loads tags and feed titles for all returned documents in batch queries, avoiding N+1 problems. Well done.

13. **Highlight text matching** — The reader uses text canonicalization and `indexOf` matching to re-render highlights from stored text — a pragmatic approach that handles whitespace differences but could fail if article content changes.

14. **Auth bypass on localhost** — `access.ts` skips JWT verification on `localhost`/`127.0.0.1`, which is appropriate for dev but worth knowing.

---

### 1.4 Assumptions Made

1. **`pnpm build` and `pnpm typecheck` currently pass** — based on the progress docs stating this. Not verified by running them.
2. **The deployed app at `canopy.annjose.com` is functional** — not attempted to access.
3. **No other branches have active work** — `git status` shows only `docs/canopy-spec.md` modified on `main`. Other branches not checked.
4. **The `.idea/` directory is JetBrains IDE config** (WebStorm/IntelliJ) — it's in the repo but also in `.gitignore`, so it's likely local-only.
5. **All progress docs taken at face value** — the existence of files and code referenced in progress docs was verified, but the app was not run to confirm features work end-to-end.

---

## 2. Files Read

### Context-provided (from system/CLAUDE.md)

- `CLAUDE.md`

### Explicitly read

| File                                                                    | Method                            |
|-------------------------------------------------------------------------|-----------------------------------|
| `AGENTS.md`                                                             | Direct Read                       |
| `docs/plans/phase-1-progress.md`                                        | Direct Read                       |
| `docs/canopy-spec.md`                                                   | Direct Read                       |
| Root directory listing (`ls -la`)                                       | Bash                              |
| `docs/plans/phase-2-progress.md`                                        | Explore agent                     |
| `docs/plans/phase-2-tags-highlight.md`                                  | Explore agent                     |
| `docs/plans/phase-3-rss-feeds.md`                                       | Explore agent                     |
| `docs/schema.sql`                                                       | Explore agent                     |
| `docs/repo-structure.md`                                                | Explore agent                     |
| `packages/shared/src/types.ts`                                          | Explore agent                     |
| `packages/shared/src/constants.ts`                                      | Explore agent                     |
| `packages/shared/src/index.ts`                                          | Explore agent                     |
| `migrations/0001_create_documents.sql`                                  | Explore agent                     |
| `migrations/0002_tags_notes_highlights.sql`                             | Explore agent                     |
| `migrations/0003_feeds.sql`                                             | Explore agent                     |
| `apps/web/src/app/layout.tsx`                                           | Explore agent                     |
| `apps/web/src/app/page.tsx`                                             | Explore agent                     |
| `apps/web/src/app/library/page.tsx`                                     | Explore agent                     |
| `apps/web/src/app/read/[id]/page.tsx`                                   | Explore agent                     |
| `apps/web/src/app/feeds/page.tsx`                                       | Explore agent                     |
| `apps/web/wrangler.toml`                                                | Explore agent                     |
| `apps/web/next.config.ts`                                               | Explore agent                     |
| `apps/web/package.json`                                                 | Explore agent                     |
| `package.json` (root)                                                   | Explore agent                     |
| `turbo.json`                                                            | Explore agent                     |
| `scripts/migrate.sh`                                                    | Explore agent                     |
| `apps/web/src/lib/db.ts`                                                | Explore agent                     |
| `apps/web/src/lib/r2.ts`                                                | Explore agent                     |
| `apps/web/src/lib/api.ts`                                               | Explore agent                     |
| `apps/web/src/lib/parser.ts`                                            | Explore agent                     |
| `apps/web/src/lib/utils.ts`                                             | Explore agent                     |
| `apps/web/src/lib/slug.ts`                                              | Explore agent                     |
| `apps/web/src/lib/access.ts`                                            | Explore agent                     |
| `apps/web/src/lib/tags.ts`                                              | Explore agent                     |
| `apps/web/src/lib/highlights.ts`                                        | Explore agent                     |
| `apps/web/src/lib/document-notes.ts`                                    | Explore agent                     |
| `apps/web/src/lib/feeds-db.ts`                                          | Explore agent                     |
| `apps/web/src/lib/feed-parser.ts`                                       | Explore agent                     |
| `apps/web/src/lib/feed-discovery.ts`                                    | Explore agent                     |
| `apps/web/src/lib/feed-poller.ts`                                       | Explore agent                     |
| `apps/web/src/hooks/use-documents.ts`                                   | Explore agent                     |
| `apps/web/src/hooks/use-document.ts`                                    | Explore agent                     |
| `apps/web/src/hooks/use-notebook.ts`                                    | Explore agent                     |
| `apps/web/src/hooks/use-tags.ts`                                        | Explore agent                     |
| `apps/web/src/hooks/use-feeds.ts`                                       | Explore agent                     |
| `apps/web/src/hooks/use-keyboard-shortcuts.ts`                          | Explore agent                     |
| `apps/web/src/hooks/use-media-query.ts`                                 | Explore agent                     |
| `apps/web/src/hooks/use-toast.tsx`                                      | Explore agent                     |
| `apps/web/src/components/layout/app-shell.tsx`                          | Explore agent                     |
| `apps/web/src/components/layout/sidebar.tsx`                            | Explore agent                     |
| `apps/web/src/components/layout/right-panel.tsx`                        | Explore agent                     |
| `apps/web/src/components/documents/document-list.tsx`                   | Explore agent                     |
| `apps/web/src/components/documents/document-row.tsx`                    | Explore agent                     |
| `apps/web/src/components/documents/status-tabs.tsx`                     | Explore agent                     |
| `apps/web/src/components/documents/save-dialog.tsx`                     | Explore agent                     |
| `apps/web/src/components/reader/reader-view.tsx`                        | Explore agent                     |
| `apps/web/src/components/reader/reader-toolbar.tsx`                     | Explore agent                     |
| `apps/web/src/components/reader/toc.tsx`                                | Explore agent                     |
| `apps/web/src/components/feeds/feed-list.tsx`                           | Explore agent                     |
| `apps/web/src/components/tags/tag-picker-dialog.tsx`                    | Explore agent                     |
| `apps/web/src/components/search/search-palette.tsx`                     | Explore agent                     |
| `apps/web/src/components/keyboard/shortcuts-help-modal.tsx`             | Explore agent                     |
| All API route files under `apps/web/src/app/api/` (21 `route.ts` files) | Explore agent (directory listing) |

**Total: ~65 source files** read across 3 parallel exploration agents + 4 direct reads.
